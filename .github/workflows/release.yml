name: Release Build

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'   # pre-release: v1.2.3-rc1

permissions:
  contents: write   # —Å–æ–∑–¥–∞–Ω–∏–µ Release –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
  models: read      # GitHub Models API (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è changelog)

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: 1
  PROJECT: src/HardwareMonitorWidget/HardwareMonitorWidget.csproj
  ARTIFACT_DIR: artifacts/release

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build:
    name: Build & Publish (win-x64)
    runs-on: windows-latest
    timeout-minutes: 20

    outputs:
      version: ${{ steps.version.outputs.value }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è changelog

      - name: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é –∏–∑ —Ç–µ–≥–∞
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"           # –Ω–∞–ø—Ä–∏–º–µ—Ä v1.2.3
          $ver = $tag -replace '^v', ''             # 1.2.3
          echo "value=$ver" >> $env:GITHUB_OUTPUT

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore HardwareMonitorWidget.sln

      - name: Build (Release)
        run: >
          dotnet build HardwareMonitorWidget.sln
          -c Release
          -p:Version=${{ steps.version.outputs.value }}
          --no-restore
          -v minimal

      # ‚îÄ‚îÄ Framework-dependent (—Ç—Ä–µ–±—É–µ—Ç .NET 8 Runtime –Ω–∞ –º–∞—à–∏–Ω–µ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Publish ‚Äî framework-dependent
        run: >
          dotnet publish ${{ env.PROJECT }}
          -c Release
          -r win-x64
          --self-contained false
          -p:Version=${{ steps.version.outputs.value }}
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -o ${{ env.ARTIFACT_DIR }}/framework-dependent
          -v minimal

      # ‚îÄ‚îÄ Self-contained (–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π, .NET Runtime –≤—Å—Ç—Ä–æ–µ–Ω) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Publish ‚Äî self-contained
        run: >
          dotnet publish ${{ env.PROJECT }}
          -c Release
          -r win-x64
          --self-contained true
          -p:Version=${{ steps.version.outputs.value }}
          -p:PublishSingleFile=true
          -p:EnableCompressionInSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -o ${{ env.ARTIFACT_DIR }}/self-contained
          -v minimal

      # ‚îÄ‚îÄ –£–ø–∞–∫–æ–≤–∞—Ç—å –≤ zip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: –£–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        shell: pwsh
        run: |
          $ver = "${{ steps.version.outputs.value }}"
          Compress-Archive `
            -Path "${{ env.ARTIFACT_DIR }}/framework-dependent/*" `
            -DestinationPath "${{ env.ARTIFACT_DIR }}/HardwareMonitorWidget-$ver-win-x64-framework-dependent.zip"
          Compress-Archive `
            -Path "${{ env.ARTIFACT_DIR }}/self-contained/*" `
            -DestinationPath "${{ env.ARTIFACT_DIR }}/HardwareMonitorWidget-$ver-win-x64-self-contained.zip"

      - name: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ job
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: ${{ env.ARTIFACT_DIR }}/*.zip
          retention-days: 1

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: –°–∫–∞—á–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist/

      - name: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å changelog —á–µ—Ä–µ–∑ Copilot
        id: changelog
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_TAG: ${{ github.ref_name }}
        with:
          result-encoding: string
          script: |
            const currentTag = process.env.CURRENT_TAG;

            // ‚îÄ‚îÄ –ù–∞–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const { execSync } = require('child_process');

            let prevTag = '';
            try {
              prevTag = execSync(
                `git describe --tags --abbrev=0 "${currentTag}^"`,
                { encoding: 'utf8' }
              ).trim();
            } catch {
              // –ü–µ—Ä–≤—ã–π —Ç–µ–≥ ‚Äî –±–µ—Ä—ë–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã
              prevTag = '';
            }

            const range = prevTag ? `${prevTag}..${currentTag}` : currentTag;

            const rawLog = execSync(
              `git log ${range} --pretty=format:"%h %s" --no-merges`,
              { encoding: 'utf8' }
            ).trim();

            if (!rawLog) {
              return '_–ù–µ—Ç –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤._';
            }

            core.info(`–ö–æ–º–º–∏—Ç—ã –¥–ª—è changelog (${range}):\n${rawLog}`);

            // ‚îÄ‚îÄ –í—ã–∑–æ–≤ GitHub Models API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const SYSTEM = `–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –ü–æ —Å–ø–∏—Å–∫—É git-–∫–æ–º–º–∏—Ç–æ–≤ —Å–æ—Å—Ç–∞–≤—å changelog —Ä–µ–ª–∏–∑–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

            –§–æ—Ä–º–∞—Ç ‚Äî —Å—Ç—Ä–æ–≥–æ Markdown:

            ### ‚ú® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
            - ...

            ### üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è
            - ...

            ### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            - ...

            ### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            - ...

            ### üèóÔ∏è –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ / –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
            - ...

            –ü—Ä–∞–≤–∏–ª–∞:
            - –ü–æ–∫–∞–∑—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ø—É–Ω–∫—Ç—ã.
            - –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç ‚Äî –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø–æ–Ω—è—Ç–Ω–æ–µ –∫–æ–Ω–µ—á–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.
            - –ù–µ –¥—É–±–ª–∏—Ä—É–π —Ö–µ—à –∫–æ–º–º–∏—Ç–∞ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∂–∞—Ä–≥–æ–Ω –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏—è.
            - –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ—Ö–æ–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç.`;

            let changelog;
            try {
              const resp = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GH_TOKEN}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  max_tokens: 1024,
                  temperature: 0.3,
                  messages: [
                    { role: 'system', content: SYSTEM },
                    { role: 'user',   content: `–ö–æ–º–º–∏—Ç—ã —Å ${prevTag || '–Ω–∞—á–∞–ª–∞'} –ø–æ ${currentTag}:\n\n${rawLog}` },
                  ],
                }),
              });

              if (resp.ok) {
                const json = await resp.json();
                changelog = json.choices?.[0]?.message?.content ?? '';
              } else {
                const text = await resp.text();
                core.warning(`GitHub Models API: ${resp.status} ‚Äî ${text}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è raw changelog.`);
                changelog = '';
              }
            } catch (err) {
              core.warning(`–û—à–∏–±–∫–∞ GitHub Models API: ${err.message}. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è raw changelog.`);
              changelog = '';
            }

            // Fallback: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π git-–ª–æ–≥
            if (!changelog) {
              changelog = rawLog
                .split('\n')
                .map(line => `- \`${line.slice(0,7)}\` ${line.slice(8)}`)
                .join('\n');
            }

            // –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ —Å raw-–∫–æ–º–º–∏—Ç–∞–º–∏ –≤ <details>
            const details = [
              '',
              '<details>',
              `<summary>üìã Raw commits (${range})</summary>`,
              '',
              '```',
              rawLog,
              '```',
              '</details>',
            ].join('\n');

            return changelog + details;

      - name: –°–æ–∑–¥–∞—Ç—å GitHub Release
        uses: actions/github-script@v7
        env:
          CHANGELOG: ${{ steps.changelog.outputs.result }}
          VERSION:   ${{ needs.build.outputs.version }}
          TAG:       ${{ github.ref_name }}
        with:
          script: |
            const fs   = require('fs');
            const path = require('path');

            const isPreRelease = process.env.TAG.includes('-');
            const version      = process.env.VERSION;

            const releaseBody = [
              `## Hardware Monitor Widget ${process.env.TAG}`,
              '',
              '### üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',
              '',
              `| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |`,
              `|------|----------|`,
              `| \`HardwareMonitorWidget-${version}-win-x64-framework-dependent.zip\` | –¢—Ä–µ–±—É–µ—Ç [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) ¬∑ –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä |`,
              `| \`HardwareMonitorWidget-${version}-win-x64-self-contained.zip\` | –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π (runtime –≤—Å—Ç—Ä–æ–µ–Ω) ¬∑ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ |`,
              '',
              '> **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:** Windows 10/11 x64, –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–¥–ª—è LibreHardwareMonitor)',
              '',
              '---',
              '',
              '## üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å',
              '',
              process.env.CHANGELOG,
            ].join('\n');

            // –°–æ–∑–¥–∞—Ç—å Release
            const { data: release } = await github.rest.repos.createRelease({
              owner:               context.repo.owner,
              repo:                context.repo.repo,
              tag_name:            process.env.TAG,
              name:                `Hardware Monitor Widget ${process.env.TAG}`,
              body:                releaseBody,
              draft:               false,
              prerelease:          isPreRelease,
              generate_release_notes: false,
            });

            core.info(`Release —Å–æ–∑–¥–∞–Ω: ${release.html_url}`);

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å zip-—Ñ–∞–π–ª—ã –∫–∞–∫ Release assets
            const distDir = 'dist';
            const files   = fs.readdirSync(distDir).filter(f => f.endsWith('.zip'));

            for (const file of files) {
              const filePath = path.join(distDir, file);
              const data     = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner:      context.repo.owner,
                repo:       context.repo.repo,
                release_id: release.id,
                name:       file,
                data:       data,
                headers:    { 'content-type': 'application/zip' },
              });

              core.info(`–ó–∞–≥—Ä—É–∂–µ–Ω: ${file}`);
            }
