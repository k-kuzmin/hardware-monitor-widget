name: Copilot Code Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.cs'
      - 'src/**/*.xaml'
      - 'src/**/*.csproj'

permissions:
  contents: read
  pull-requests: write
  models: read   # GitHub Models API

jobs:
  audit:
    name: Security / Performance / Architecture Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Copilot Audit
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const MAX_DIFF_CHARS = 28_000;

            // ‚îÄ‚îÄ 1. –ü–æ–ª—É—á–∏—Ç—å diff PR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });

            const relevant = files.filter(f =>
              /\.(cs|xaml|csproj)$/.test(f.filename) && f.patch
            );

            if (relevant.length === 0) {
              core.info('–ù–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö .cs/.xaml/.csproj —Ñ–∞–π–ª–æ–≤ ‚Äî –∞—É–¥–∏—Ç –ø—Ä–æ–ø—É—â–µ–Ω.');
              return;
            }

            let diff = relevant
              .map(f => `### ${f.filename}\n\`\`\`diff\n${f.patch}\n\`\`\``)
              .join('\n\n');

            if (diff.length > MAX_DIFF_CHARS) {
              diff = diff.slice(0, MAX_DIFF_CHARS) + '\n\n... (diff —É—Å–µ—á—ë–Ω –¥–æ 28 000 —Å–∏–º–≤–æ–ª–æ–≤)';
            }

            // ‚îÄ‚îÄ 2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const SYSTEM = `–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π senior .NET —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ WPF, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
            –ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ git-diff –∏ —Å–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

            –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ Markdown —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏:

            ## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
            –°–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: command injection, path traversal, —É—Ç–µ—á–∫–∏ —Å–µ–Ω—Å–∏—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤—ã–∑–æ–≤—ã P/Invoke –∏ —Ç.–ø.
            –î–ª—è –∫–∞–∂–¥–æ–π: **[CRITICAL/HIGH/MEDIUM/LOW]** ‚Äî —Ñ–∞–π–ª:—Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è.
            –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç, –Ω–∞–ø–∏—Å–∞—Ç—å: _–£—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ._

            ## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            –°–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º: –Ω–µ–Ω—É–∂–Ω—ã–µ –∞–ª–ª–æ–∫–∞—Ü–∏–∏, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI-–ø–æ—Ç–æ–∫–∞, –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç.–ø.
            –î–ª—è –∫–∞–∂–¥–æ–π: **[HIGH/MEDIUM/LOW]** ‚Äî —Ñ–∞–π–ª:—Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è.
            –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç, –Ω–∞–ø–∏—Å–∞—Ç—å: _–ü—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ._

            ## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
            –°–ø–∏—Å–æ–∫ –Ω–∞—Ä—É—à–µ–Ω–∏–π: SOLID, SRP, DI, —É—Ç–µ—á–∫–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π, —Å–º–µ—à–µ–Ω–∏–µ —Å–ª–æ—ë–≤, –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥ –∏ —Ç.–ø.
            –î–ª—è –∫–∞–∂–¥–æ–π: **[HIGH/MEDIUM/LOW]** ‚Äî —Ñ–∞–π–ª:—Å—Ç—Ä–æ–∫–∞ ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è.
            –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ—Ç, –Ω–∞–ø–∏—Å–∞—Ç—å: _–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π –Ω–µ—Ç._

            ## ‚úÖ –ò—Ç–æ–≥
            –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (2‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è): –æ–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–ª—é—á–µ–≤—ã–µ —Ä–∏—Å–∫–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (approve / request changes).

            –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ diff (—Å—Ç—Ä–æ–∫–∏ –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å +). –ù–µ –¥–∞–≤–∞–π –æ–±—â–∏—Ö —Å–æ–≤–µ—Ç–æ–≤, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏—Ö—Å—è –∫ –∫–æ–¥—É –≤ diff.`;

            // ‚îÄ‚îÄ 3. –í—ã–∑–æ–≤ GitHub Models API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let reportBody;
            try {
              const resp = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.GH_TOKEN}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  model: 'gpt-4o',
                  max_tokens: 2048,
                  temperature: 0.2,
                  messages: [
                    { role: 'system', content: SYSTEM },
                    { role: 'user',   content: `–ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ PR diff:\n\n${diff}` },
                  ],
                }),
              });

              if (!resp.ok) {
                const text = await resp.text();
                core.setFailed(`GitHub Models API –≤–µ—Ä–Ω—É–ª ${resp.status}: ${text}`);
                return;
              }

              const json = await resp.json();
              reportBody = json.choices?.[0]?.message?.content ?? '_(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏)_';
            } catch (err) {
              core.setFailed(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ GitHub Models API: ${err.message}`);
              return;
            }

            // ‚îÄ‚îÄ 4. –ù–∞–π—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const MARKER = '<!-- copilot-audit-report -->';
            const header = [
              MARKER,
              `## ü§ñ Copilot Audit Report`,
              `> PR #${context.payload.pull_request.number} ¬∑ ${relevant.length} —Ñ–∞–π–ª(–æ–≤) –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ¬∑ ` +
              `${new Date().toISOString().slice(0, 16).replace('T', ' ')} UTC`,
              '',
            ].join('\n');

            const fullComment = header + '\n' + reportBody;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c => c.body?.includes(MARKER));

            if (existing) {
              await github.rest.issues.updateComment({
                owner:      context.repo.owner,
                repo:       context.repo.repo,
                comment_id: existing.id,
                body:       fullComment,
              });
              core.info(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞—É–¥–∏—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω (id ${existing.id}).`);
            } else {
              await github.rest.issues.createComment({
                owner:       context.repo.owner,
                repo:        context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body:        fullComment,
              });
              core.info('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞—É–¥–∏—Ç–∞ —Å–æ–∑–¥–∞–Ω.');
            }
